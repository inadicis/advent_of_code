steps:
  - id: Build-test-image
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'docker build -t testimage -f deployment/Dockerfile-test . '

    env:
      - 'DOCKER_BUILDKIT=1'

  - id: Run-tests
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'docker run testimage python3 -m pytest'

  - id: Build-actual-image
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - "docker build \
      -t $_DEPLOY_REGION-docker.pkg.dev/\
      $PROJECT_ID/${_IMAGE_REPOSITORY}/${_IMAGE}:${TAG_NAME} \
      -f deployment/Dockerfile \
      ."
    env:
      - 'DOCKER_BUILDKIT=1'

  - id: Push-image-to-registry
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - "\
        ${_DEPLOY_REGION}-docker.pkg.dev/\
        $PROJECT_ID/${_IMAGE_REPOSITORY}/${_IMAGE}:${TAG_NAME}"

  - id: Deploy-new-revision
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    timeout: 300s
    args:
      - '-c'
      - "\
        gcloud run deploy ${_SERVICE_NAME} \
        --image=${_DEPLOY_REGION}-docker.pkg.dev/\
        $PROJECT_ID/${_IMAGE_REPOSITORY}/${_IMAGE}:${TAG_NAME} \
        --tag=${_REVISION_TAG} \
        --revision-suffix=${_REVISION_TAG}-$$RANDOM \
        --region=${_DEPLOY_REGION} \
        --min-instances=0 \
        --max-instances=5 \
        --service-account=${_RUN_SERVICE_ACCOUNT} \
        --platform=${_PLATFORM} \
        --allow-unauthenticated \
        --set-env-vars=\
        DEPLOY_ENVIRONMENT=${_DEPLOY_ENVIRONMENT},\
        KEEP_THIS_AS_LAST_SET_ENV=true \
        
      "

tags:
  - build
  - test
  - deploy
  - $_SERVICE_NAME
  - $_DEPLOY_ENVIRONMENT
  - $TAG_NAME

# TODO-CONFIG verify and update substitutions
substitutions:
  _PLATFORM: managed
  _DEPLOY_REGION: europe-west3
  _DEPLOY_ENVIRONMENT: DEV
  _SERVICE_NAME:  advent-of-code-2023-dev
  _IMAGE_REPOSITORY:  advent-of-code-2023
  _IMAGE:   advent_of_code_2023
  _REVISION_TAG: ${TAG_NAME//./-}
  _RUN_SERVICE_ACCOUNT:
# Substitutions can be set (or overwritten) in GCP in the trigger
  # as well instead to inside this yaml file

options:
    dynamic_substitutions: true
    logging: CLOUD_LOGGING_ONLY
